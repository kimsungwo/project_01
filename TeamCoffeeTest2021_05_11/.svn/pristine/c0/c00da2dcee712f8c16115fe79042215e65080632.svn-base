package com.teamcoffee.buy.service;


import java.util.ArrayList;
import java.util.List;

import org.mybatis.spring.SqlSessionTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.teamcoffee.buy.vo.BuyDetailOptionVO;
import com.teamcoffee.buy.vo.BuyDetailVO;
import com.teamcoffee.buy.vo.BuyVO;
import com.teamcoffee.cart.vo.CartViewVO;
import com.teamcoffee.member.vo.MemberVO;

@Service("buyService")
public class BuyServiceImpl implements BuyService{
	@Autowired
	private SqlSessionTemplate sqlSession;

	@Override
	public MemberVO selectBuyerInfo(MemberVO memberVO) {
		return sqlSession.selectOne("selectBuyerInfo", memberVO);
	}

	@Transactional(rollbackFor = Exception.class)
	@Override
	public int insertBuyList(BuyVO buyVO) {
		
		//구매 테이블에 insert
		int result1 = sqlSession.insert("insertBuyList", buyVO);
		
		//구매 상세조회에 insert
		String buyCode = sqlSession.selectOne("selectMaxBuyCode");
		
		List<CartViewVO> buyMenus = sqlSession.selectList("selectBuyMenuList", buyVO);
		for(CartViewVO e : buyMenus) {
			BuyDetailVO bd = new BuyDetailVO();
			bd.setBuyCode(buyCode);
			bd.setMenuCode(e.getMenuCode());
			bd.setBuyQuantity(e.getBuyQuantity());
			bd.setBuyPrice(e.getCartPrice());
			sqlSession.insert("insertBuyMenu", bd);
			
			//상세 조회별 옵션 insert
			String buyDetailCode = sqlSession.selectOne("selectMaxBuyDetailCode");
			int nextDetailOptionNum = sqlSession.selectOne("selectMaxDetailOptionNum");
			
			List<BuyDetailOptionVO> buyDetailOptions = new ArrayList<>();
			
			List<CartViewVO> buyMenuDetails = sqlSession.selectList("selectBuyMenuDetailList", e);
			for(CartViewVO f : buyMenuDetails) {
				BuyDetailOptionVO bdo = new BuyDetailOptionVO();
				bdo.setBuyDetailOptionCode("BUY_DO_" + String.format("%03d", nextDetailOptionNum++));
				bdo.setBuyDetailCode(buyDetailCode);
				bdo.setMenuOptionCode(f.getMenuOptionCode());
				buyDetailOptions.add(bdo);
			}
			BuyDetailOptionVO buyDetailOptionVO = new BuyDetailOptionVO();
			buyDetailOptionVO.setBuyDetailOptions(buyDetailOptions);
			
			sqlSession.insert("insertBuyMenuOption", buyDetailOptionVO);
		}
		
		return result1;
	}

	@Override
	public int selectCartCodeSize(MemberVO memberVO) {
		return sqlSession.selectOne("selectCartCodeSize", memberVO);
	}
	
}
