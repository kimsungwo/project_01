/* 페이지 로딩 후 실행 */
$(document).ready(function(){
	
	$('.menuName').each(function(){
		const selectedTag = $(this);
		selectBuyListMenu(selectedTag);
	})
	
	$('.buyStatusBar').each(function(){
		const buyStatus = $(this).attr('data-buyStatus');
		if(buyStatus == 0){
			$(this).attr('style', 'width: 100%');
			$(this).addClass('bg-danger');
		}
		else if(buyStatus == 1){
			$(this).attr('style', 'width: 33%');
			$(this).addClass('progress-bar-animated');
		}
		else if(buyStatus == 2){
			$(this).attr('style', 'width: 66%');
			$(this).addClass('progress-bar-animated bg-info');
		}
		else if(buyStatus == 3){
			$(this).attr('style', 'width: 100%');
			$(this).addClass('bg-success');
		}
	})
	
	$('#buyDetail').on('hidden.bs.modal', function (event) {
		$('.buyMenuDetail').empty();
		$('.menuOption').empty();
		$('.pointModal').remove();
	})	
	
	$('#buyDetail').on('show.bs.modal', function (event) {
		
	})	
	
});

/* 함수선언 영역*/
(function($){
    selectBuyListMenu = function(selectedTag){
    	const buyCode = selectedTag.attr('data-buyCode');
    	$.ajax({
            url: '/buy/selectBuyListMenu', //요청경로
            type: 'post',
            data:{'buyCode' : buyCode}, //필요한 데이터
            success: function(result) {
               //ajax 실행 성공 후 실행할 코드 작성
            	let str = '';
               $(result).each(function(i){
            	   str += result[i].menuName + ' x ' + result[i].buyQuantity;
            	   if(result[i+1] != null){
            		   str += ', ';
            	   }
               })
               selectedTag.text(str);
            },
            error: function(){
             //ajax 실행 실패 시 실행되는 구간
               alert('실패');
            }
      });
    }
    
    selectBuyDetail = function(buyCode){
    	selectBuyPoint(buyCode);
    	$.ajax({
            url: '/buy/selectBuyDetail', //요청경로
            type: 'post',
            data:{'buyCode' : buyCode}, //필요한 데이터
            success: function(result) {
               //ajax 실행 성공 후 실행할 코드 작성
            	$('#buyDetailLabel').text(result[0].buyStatusName);
            	$('.cafeNameModal').text(result[0].cafeName);
            	$('.buyDateModal').text(result[0].buyDate);
            	if(result[0].buyRequests == null){
            		$('.buyRequestsModal').text('(없음)');
            	}
            	else{
            		$('.buyRequestsModal').text(result[0].buyRequests);
            	}
            	$('.totalPriceModal').text(result[0].totalPrice + '원');
            	selectBuyDetailMenu(buyCode);
            },
            error: function(){
             //ajax 실행 실패 시 실행되는 구간
               alert('실패');
            }
      });

    }
    
	selectBuyDetailMenu = function(buyCode){
		$.ajax({
            url: '/buy/selectBuyDetailMenu', //요청경로
            type: 'post',
            data:{'buyCode' : buyCode}, //필요한 데이터
            success: function(result) {
               if(result != null){
            	   let str = '';
            	   $(result).each(function(i){
            		   str += '<div class="col-8 buyMenuName">' + result[i].menuName + ' x ' + result[i].buyQuantity + '</div>';
            		   str += '<div class="col-4 text-right"><span class="menuPriceModal">' + result[i].menuPrice * result[i].buyQuantity +'</span>원</div>';
            		   str += '<div class="col-12"><div class="row menuOption" id="' + result[i].buyDetailCode + '"></div></div></div>'
            		   
            	   })
            	   $('.buyMenuDetail').append(str);
            	   $(result).each(function(i){
            		   selectBuyDetailMenuOption(buyCode, result[i].buyDetailCode);
            	   })
               }
               
            },
            error: function(){
             //ajax 실행 실패 시 실행되는 구간
               alert('실패');
            }
      });

	}
	
	selectBuyDetailMenuOption = function(buyCode, buyDetailCode){
		$.ajax({
            url: '/buy/selectBuyDetailMenuOption', //요청경로
            type: 'post',
            data:{'buyCode' : buyCode, 'buyDetailCode' : buyDetailCode}, //필요한 데이터
            success: function(result) {
               //ajax 실행 성공 후 실행할 코드 작성
            	if(result != null){
            		let str = '';
            		$(result).each(function(i){
            			str += '<div class="col-8">- ' + result[i].menuOptionGroupName;
            			if(result[i].menuOptionGroupType == 1){
            				str += ' 선택 : ';
            			}
            			else{
            				str += ' (추가) : ';
            			}
            			str += result[i].menuOptionName + '</div><div class="col-4 text-right"><span class="menuOptionPriceModal">' + result[i].menuOptionPrice * result[i].buyQuantity +'</span>원</div>';
            		})
            		$('#' + buyDetailCode +'').append(str);
            	}
            	updateTotalPrice();
            },
            error: function(){
             //ajax 실행 실패 시 실행되는 구간
               alert('실패');
            }
      });

	}
	
	updateTotalPrice = function(){
		let menuPrice = 0;
		let menuOptionPrice = 0;
		$('.menuPriceModal').each(function(){
			menuPrice = parseInt(menuPrice) + parseInt($(this).text());
		})
		$('.menuOptionPriceModal').each(function(){
			menuOptionPrice = parseInt(menuOptionPrice) + parseInt($(this).text());
		})
		let totalPrice = parseInt(menuPrice) + parseInt(menuOptionPrice)
		$('.allPrice').text(totalPrice + '원');
	}
	
	selectBuyPoint = function(buyCode){
    	$.ajax({
            url: '/buy/selectBuyPoint', //요청경로
            type: 'post',
            data:{'buyCode' : buyCode}, //필요한 데이터
            success: function(result) {
               //ajax 실행 성공 후 실행할 코드 작성
            	if(result != null){
            		let str = '';
            		str += '<div class="pointModal"></div><hr>';
            		$('.buyDetails').next().append();
            	}
            },
            error: function(){
             //ajax 실행 실패 시 실행되는 구간
               alert('실패');
            }
      });

    }
	
	
})(jQuery);